
name: Test Installation

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:

jobs:
  # Test Ubuntu with user install (most common case)
  test-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test user-local install
        run: |
          chmod +x install.sh
          INSTALL_DIR=$HOME/.local/bin ./install.sh
      - name: Add to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Verify
        run: |
          which dockmate
          file $(which dockmate)
          dockmate --version || echo "No version flag"

  # Test macOS ARM (M1/M2) - most common Mac now
  test-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: System info
        run: uname -a
      - name: Test install
        run: |
          chmod +x install.sh
          INSTALL_DIR=$HOME/.local/bin ./install.sh
      - name: Add to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Verify architecture
        run: |
          file $(which dockmate)
          dockmate --version || echo "No version flag"

  # Test macOS Intel - still common
  test-macos-intel:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - name: Test install
        run: |
          chmod +x install.sh
          INSTALL_DIR=$HOME/.local/bin ./install.sh
      - name: Add to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Verify
        run: dockmate --version || echo "No version flag"

  # Test system-wide install with sudo
  test-system-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test sudo install to /usr/local/bin
        run: |
          chmod +x install.sh
          sudo ./install.sh
      - name: Verify system install
        run: |
          which dockmate
          dockmate --version || echo "No version flag"

  # Test Docker container (no sudo, minimal env)
  test-container:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: Install deps
        run: apk add --no-cache bash curl git
      - uses: actions/checkout@v4
      - name: Test as root in container
        run: |
          chmod +x install.sh
          INSTALL_DIR=/usr/local/bin ./install.sh
      - name: Verify
        run: dockmate --version || echo "No version flag"

  # Test checksum verification
  test-checksum:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify checksum works
        run: |
          chmod +x install.sh
          INSTALL_DIR=$HOME/.local/bin ./install.sh | tee install.log
          grep -q "Checksum verified" install.log
      - name: Test binary works
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          dockmate --version || echo "No version flag"